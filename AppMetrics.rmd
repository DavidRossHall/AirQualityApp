---
title: "Review of Air Quality App Usage"
runningheader: "Air Quality App Usage" # only for pdf output
author: "David Hall"
date: "`r Sys.Date()`"
output:
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_html: default
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
library(tidyverse)
library(cowplot)
# invalidate cache when the tufte version changes
knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
```

# Background

The CHM135 Winter 2020 Practical 1 has wrapped up, and I downgraded our server status to the base (free) option. Given that it'll be a while until we get student feedback, I though I would comb through the sparse shiny apps metrics and see if I could get a better idea of how the app was used. 

# Results and Discussion

There isn't much recorded by the Shiny server in terms of user metrics; the metrics that are recorded relate to server usage and not user experience. A useful metric is "connections", as in "when a person goes to the app website". Note that there can be multiple connections for a given individual (i.e. they go to the website on two different days). Nonetheless, it provides a useful approximate for the number of people who've used the app. Figure 1 shows the app connections over time. Predictably, the most connection are towards the tail end of the *Practical 1* synchronous sessions (Jan 18th to 22rd), and peaking over the weekend. 

```{r app-connections, fig.height = 2.5, echo = FALSE, error = FALSE, message = FALSE, warning = FALSE, fig.cap="Connections to Air Quality app per day (top) and cummulative connections over time (bottom)."}

# Code modified from Simon Woodward, Stack Overflow; https://stackoverflow.com/a/53733859
# 
# df <- rsconnect::showMetrics("container_status",
#                              c("connect_count", 
#                                "connect_procs"),
#                              appName="AirQualityApp",
#                              server="shinyapps.io",
#                              from="4w",
#                              interval="1m"
# ) 
# 
# colnames(df) <- c("connect_count", "metricSeries", "connect_procs", "timestamp" )
# 
# #write.csv(df, file = "container_status_Practical1.csv")

df <- read.csv("container_status_Practical1.csv")

df1 <- df %>% 
  mutate(date=as.POSIXct(as.numeric(as.character(timestamp)),origin="1970-01-01")) %>% 
  mutate(connect_count = as.numeric(connect_count)) %>%
  mutate(connect_procs = as.numeric(connect_procs)) %>%
  select(-timestamp) %>% 
  arrange(date) %>% 
  mutate(
    n_count=cumsum(connect_count),
    n_procs=cumsum(connect_procs),
    new_connect=case_when(
      connect_count>lag(connect_count,1) ~ connect_count-lag(connect_count,1),
      TRUE ~ 0),
    n_connect=cumsum(new_connect) # approximate
  ) %>% 
  filter(n_count>0)

df2 <- df1 %>%  
  select(n_connect, date) %>% 
  gather(key="key", value="value", -date)

# Values for rectangle

syncStart = as.POSIXct("2021-01-18", origin = "1970-01-01")
syncEnd = as.POSIXct("2021-01-23", origin = "1970-01-01")

p <- ggplot(df2) +
  labs(x="Date", y="Cumulative\nConnections") +
  geom_line(aes(x=date, y=value)) +
  theme_classic()

df3 <- df1 %>%
  mutate(date2 = as.Date(date)) %>%
  group_by(date2) %>%
  summarize(size = max(n_connect)) %>%
  mutate(dayCount = size - lag(size))

p2 <- ggplot(df3, aes(x = date2, y = dayCount)) +
  geom_bar(fill="gray", stat = "identity") +  theme(axis.title=element_blank()) +
  scale_y_continuous(breaks=seq(0, 70, 20)) +
  labs(y = "Connections\nper day") +
  theme_classic() +
  theme(axis.line.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.x=element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.grid.major.x=element_blank())
  

#grid.arrange(p2, p, ncol = 1)
plot_grid(p2, p, ncol = 1, align = "v")

```

## Server time

From the Shiny website, **we've used 77.8 hrs** over the course of the lab period. With **260 connections**, it means that **each connection (read user session) lasted approximately 18 minutes**. Some of these connection are ours (i.e. me checking on the app), but we also didn't spend too long looking at elements on the app, so I believe the 18 minutes/student is a reasonable measurement of student engagement with the App. Note, this is the time that a person was on the website, and not the amount of time the servers spent running calculations and fetching data. 

| Metric            | Numbers  |
|-------------------|----------|
| Total Connections | 260      |
| Server time       | 77.8 hrs |
| Time/connection   | 18 mins  |

Table: Summary of student engagement (approximate)